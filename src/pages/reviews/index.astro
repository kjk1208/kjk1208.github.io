---
import DocsLayout from '../../layouts/DocsLayout.astro';
import { getCollection } from 'astro:content';

// 포스트 목록/카테고리 계산
const posts = (await getCollection('reviews', (p) => !p.data.draft))
  .sort((a, b) => (a.data.date < b.data.date ? 1 : -1));

const cats = Array.from(new Set(posts.map((p) => p.data.category).filter(Boolean)));
const sidebarLinks = [{ href: '/reviews/', label: '전체' }, ...cats.map((c) => ({ href: '/reviews/?cat=' + encodeURIComponent(c), label: c }))];

const url = new URL(Astro.request.url);
const cat = url.searchParams.get('cat');
const visible = cat ? posts.filter((p) => p.data.category === cat) : posts;
---

<DocsLayout sidebarTitle="카테고리" {sidebarLinks}>
  <!-- 제목 + 버튼 -->
  <section class="page-head">
    <h1>논문 리뷰</h1>
    <!-- 오너 로그인 시에만 보이도록: BaseLayout의 .only-owner 규칙을 그대로 사용 -->
    <a id="write-reviews" class="button only-owner" target="_blank" rel="noopener">리뷰 글쓰기</a>
  </section>

  {cat && <p class="small">카테고리: <strong>{cat}</strong> • <a href="/reviews/">카테고리 해제</a></p>}

  <div class="post-list">
    {visible.map((p) => (
      <article class="post-item">
        <h3><a href={`/reviews/${p.slug}/`}>{p.data.title}</a></h3>
        <div class="small">
          {p.data.date}
          {p.data.tags.length ? ` • ${p.data.tags.join(', ')}` : ''}
        </div>
        {p.data.summary && <p style="margin:.4rem 0 0 0;">{p.data.summary}</p>}
      </article>
    ))}
  </div>

  <style>
    .page-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin: 0 0 1rem;
    }
  </style>

  <!-- GitHub 새 파일 링크 빌드(ES5/안전) -->
  <script is:raw>
  (function(){
    function ready(fn){
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn);
      else fn();
    }
    ready(function(){
      var btn = document.getElementById('write-reviews');
      if (!btn) return;

      var today = new Date().toISOString().slice(0,10);

      // Frontmatter 템플릿
      var frontmatter = [
        '---',
        'title: "제목"',
        'date: "' + today + '"',
        'category: ""',
        'tags: []',
        'draft: false',
        'summary: ""',
        '---',
        '',
        '여기에 본문을 작성하세요.',
        ''
      ].join('\n');

      function build(path, filename, content){
        var url = new URL('https://github.com/kjk1208/kjk1208.github.io/new/main/' + path);
        url.searchParams.set('filename', filename);
        url.searchParams.set('value', content);
        return url.toString();
      }

      // 버튼 링크 설정
      btn.href = build('src/content/reviews', today + '-my-review.mdx', frontmatter);
    });
  })();
  </script>
</DocsLayout>